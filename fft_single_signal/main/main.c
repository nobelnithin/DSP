#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "esp_system.h"
#include "driver/spi_master.h"
#include "soc/gpio_struct.h"
#include "driver/gpio.h"
#include "driver/uart.h"
#include "soc/uart_struct.h"
#include <math.h>

#include "esp_dsp.h"

static const char *TAG = "main";

// This example shows how to use FFT from esp-dsp library

#define N_SAMPLES 1024
int N = N_SAMPLES;
// Input test array
__attribute__((aligned(16)))
float x[N_SAMPLES] = {0,0.359895036534988,0.671558954847018,0.893224301195515,0.995184726672197,0.963776065795440,0.803207531480645,0.534997619887098,0.195090322016129,-0.170961888760301,-0.514102744193222,-0.788346427626606,-0.956940335732209,-0.997290456678690,-0.903989293123444,-0.689540544737067,-0.382683432365090,-0.0245412285229133,0.336889853392220,0.653172842953776,0.881921264348355,0.992479534598710,0.970031253194544,0.817584813151585,0.555570233019604,0.219101240156870,-0.146730474455361,-0.492898192229783,-0.773010453362736,-0.949528180593036,-0.998795456205172,-0.914209755703531,-0.707106781186549,-0.405241314004991,-0.0490676743274201,0.313681740398891,0.634393284163645,0.870086991108711,0.989176509964781,0.975702130038529,0.831469612302546,0.575808191417846,0.242980179903265,-0.122410675199214,-0.471396736825996,-0.757208846506483,-0.941544065183020,-0.999698818696204,-0.923879532511288,-0.724247082951467,-0.427555093430283,-0.0735645635996688,0.290284677254461,0.615231590580625,0.857728610000271,0.985277642388941,0.980785280403231,0.844853565249709,0.595699304492437,0.266712757474899,-0.0980171403295594,-0.449611329654605,-0.740951125354958,-0.932992798834738,-1,-0.932992798834740,-0.740951125354961,-0.449611329654610,-0.0980171403295648,0.266712757474894,0.595699304492432,0.844853565249706,0.980785280403230,0.985277642388942,0.857728610000274,0.615231590580629,0.290284677254466,-0.0735645635996634,-0.427555093430278,-0.724247082951464,-0.923879532511286,-0.999698818696204,-0.941544065183022,-0.757208846506486,-0.471396736826000,-0.122410675199220,0.242980179903260,0.575808191417845,0.831469612302543,0.975702130038528,0.989176509964782,0.870086991108713,0.634393284163650,0.313681740398894,-0.0490676743274112,-0.405241314004987,-0.707106781186542,-0.914209755703529,-0.998795456205172,-0.949528180593038,-0.773010453362738,-0.492898192229789,-0.146730474455364,0.219101240156863,0.555570233019599,0.817584813151580,0.970031253194543,0.992479534598710,0.881921264348357,0.653172842953778,0.336889853392225,-0.0245412285229097,-0.382683432365084,-0.689540544737065,-0.903989293123440,-0.997290456678690,-0.956940335732211,-0.788346427626609,-0.514102744193223,-0.170961888760307,0.195090322016126,0.534997619887092,0.803207531480643,0.963776065795438,0.995184726672197,0.893224301195519,0.671558954847022,0.359895036534996,5.38968387752153e-15,-0.359895036534986,-0.671558954847014,-0.893224301195514,-0.995184726672196,-0.963776065795441,-0.803207531480650,-0.534997619887101,-0.195090322016137,0.170961888760296,0.514102744193214,0.788346427626603,0.956940335732208,0.997290456678691,0.903989293123445,0.689540544737072,0.382683432365094,0.0245412285229205,-0.336889853392215,-0.653172842953770,-0.881921264348352,-0.992479534598709,-0.970031253194546,-0.817584813151586,-0.555570233019608,-0.219101240156874,0.146730474455354,0.492898192229780,0.773010453362731,0.949528180593035,0.998795456205173,0.914209755703533,0.707106781186550,0.405241314004996,0.0490676743274219,-0.313681740398884,-0.634393284163642,-0.870086991108707,-0.989176509964780,-0.975702130038531,-0.831469612302549,-0.575808191417854,-0.242980179903271,0.122410675199212,0.471396736825991,0.757208846506482,0.941544065183020,0.999698818696204,0.923879532511290,0.724247082951476,0.427555093430285,0.0735645635996742,-0.290284677254452,-0.615231590580615,-0.857728610000270,-0.985277642388940,-0.980785280403233,-0.844853565249708,-0.595699304492438,-0.266712757474908,0.0980171403295470,0.449611329654604,0.740951125354954,0.932992798834735,1,0.932992798834741,0.740951125354965,0.449611329654618,0.0980171403295631,-0.266712757474892,-0.595699304492425,-0.844853565249700,-0.980785280403230,-0.985277642388943,-0.857728610000278,-0.615231590580628,-0.290284677254468,0.0735645635996580,0.427555093430270,0.724247082951465,0.923879532511284,0.999698818696204,0.941544065183026,0.757208846506488,0.471396736826005,0.122410675199229,-0.242980179903262,-0.575808191417840,-0.831469612302540,-0.975702130038526,-0.989176509964782,-0.870086991108715,-0.634393284163654,-0.313681740398906,0.0490676743274129,0.405241314004982,0.707106781186538,0.914209755703530,0.998795456205172,0.949528180593040,0.773010453362746,0.492898192229788,0.146730474455370,-0.219101240156858,-0.555570233019589,-0.817584813151580,-0.970031253194542,-0.992479534598712,-0.881921264348357,-0.653172842953782,-0.336889853392231,0.0245412285228972,0.382683432365085,0.689540544737061,0.903989293123438,0.997290456678689,0.956940335732211,0.788346427626613,0.514102744193234,0.170961888760305,-0.195090322016121,-0.534997619887087,-0.803207531480636,-0.963776065795438,-0.995184726672198,-0.893224301195521,-0.671558954847031,-0.359895036534995,-1.07793677550431e-14,0.359895036534974,0.671558954847015,0.893224301195512,0.995184726672196,0.963776065795444,0.803207531480649,0.534997619887106,0.195090322016142,-0.170961888760284,-0.514102744193215,-0.788346427626599,-0.956940335732204,-0.997290456678691,-0.903989293123447,-0.689540544737076,-0.382683432365105,-0.0245412285229188,0.336889853392210,0.653172842953766,0.881921264348346,0.992479534598709,0.970031253194547,0.817584813151593,0.555570233019607,0.219101240156879,-0.146730474455348,-0.492898192229769,-0.773010453362732,-0.949528180593033,-0.998795456205173,-0.914209755703538,-0.707106781186554,-0.405241314005001,-0.0490676743274344,0.313681740398886,0.634393284163638,0.870086991108705,0.989176509964778,0.975702130038530,0.831469612302552,0.575808191417858,0.242980179903283,-0.122410675199207,-0.471396736825986,-0.757208846506474,-0.941544065183019,-0.999698818696205,-0.923879532511292,-0.724247082951480,-0.427555093430290,-0.0735645635996795,0.290284677254447,0.615231590580611,0.857728610000267,0.985277642388939,0.980785280403234,0.844853565249711,0.595699304492442,0.266712757474913,-0.0980171403295416,-0.449611329654599,-0.740951125354951,-0.932992798834733,-1,-0.932992798834743,-0.740951125354969,-0.449611329654623,-0.0980171403295684,0.266712757474887,0.595699304492421,0.844853565249697,0.980785280403229,0.985277642388944,0.857728610000281,0.615231590580632,0.290284677254473,-0.0735645635996527,-0.427555093430265,-0.724247082951461,-0.923879532511282,-0.999698818696204,-0.941544065183028,-0.757208846506491,-0.471396736826010,-0.122410675199234,0.242980179903257,0.575808191417836,0.831469612302537,0.975702130038524,0.989176509964782,0.870086991108718,0.634393284163648,0.313681740398898,-0.0490676743274075,-0.405241314004977,-0.707106781186535,-0.914209755703522,-0.998795456205171,-0.949528180593037,-0.773010453362741,-0.492898192229792,-0.146730474455375,0.219101240156853,0.555570233019584,0.817584813151569,0.970031253194537,0.992479534598711,0.881921264348359,0.653172842953786,0.336889853392236,-0.0245412285228918,-0.382683432365067,-0.689540544737046,-0.903989293123442,-0.997290456678690,-0.956940335732212,-0.788346427626616,-0.514102744193238,-0.170961888760324,0.195090322016101,0.534997619887095,0.803207531480641,0.963776065795437,0.995184726672198,0.893224301195524,0.671558954847035,0.359895036535013,3.03799063477666e-14,-0.359895036534983,-0.671558954847011,-0.893224301195509,-0.995184726672195,-0.963776065795446,-0.803207531480660,-0.534997619887122,-0.195090322016133,0.170961888760292,0.514102744193211,0.788346427626596,0.956940335732203,0.997290456678692,0.903989293123456,0.689540544737070,0.382683432365097,0.0245412285229242,-0.336889853392205,-0.653172842953762,-0.881921264348344,-0.992479534598707,-0.970031253194545,-0.817584813151588,-0.555570233019611,-0.219101240156884,0.146730474455343,0.492898192229764,0.773010453362720,0.949528180593027,0.998795456205173,0.914209755703535,0.707106781186558,0.405241314005006,0.0490676743274398,-0.313681740398867,-0.634393284163623,-0.870086991108709,-0.989176509964780,-0.975702130038531,-0.831469612302555,-0.575808191417862,-0.242980179903288,0.122410675199188,0.471396736825994,0.757208846506479,0.941544065183017,0.999698818696205,0.923879532511294,0.724247082951483,0.427555093430307,0.0735645635996991,-0.290284677254455,-0.615231590580618,-0.857728610000264,-0.985277642388938,-0.980785280403235,-0.844853565249721,-0.595699304492458,-0.266712757474904,0.0980171403295504,0.449611329654594,0.740951125354947,0.932992798834731,1,0.932992798834750,0.740951125354963,0.449611329654615,0.0980171403295738,-0.266712757474882,-0.595699304492416,-0.844853565249694,-0.980785280403225,-0.985277642388947,-0.857728610000276,-0.615231590580637,-0.290284677254478,0.0735645635996473,0.427555093430260,0.724247082951448,0.923879532511275,0.999698818696204,0.941544065183025,0.757208846506495,0.471396736826015,0.122410675199239,-0.242980179903238,-0.575808191417820,-0.831469612302542,-0.975702130038526,-0.989176509964783,-0.870086991108721,-0.634393284163663,-0.313681740398916,0.0490676743273879,0.405241314004959,0.707106781186541,0.914209755703525,0.998795456205172,0.949528180593043,0.773010453362753,0.492898192229809,0.146730474455395,-0.219101240156861,-0.555570233019592,-0.817584813151574,-0.970031253194539,-0.992479534598713,-0.881921264348368,-0.653172842953801,-0.336889853392227,0.0245412285229007,0.382683432365075,0.689540544737053,0.903989293123433,0.997290456678688,0.956940335732218,0.788346427626628,0.514102744193231,0.170961888760316,-0.195090322016110,-0.534997619887078,-0.803207531480629,-0.963776065795432,-0.995184726672200,-0.893224301195520,-0.671558954847029,-0.359895036535005,-2.15587355100861e-14,0.359895036534964,0.671558954846997,0.893224301195500,0.995184726672196,0.963776065795443,0.803207531480655,0.534997619887115,0.195090322016152,-0.170961888760273,-0.514102744193194,-0.788346427626601,-0.956940335732205,-0.997290456678691,-0.903989293123452,-0.689540544737084,-0.382683432365115,-0.0245412285229438,0.336889853392187,0.653172842953769,0.881921264348348,0.992479534598708,0.970031253194550,0.817584813151599,0.555570233019628,0.219101240156903,-0.146730474455352,-0.492898192229772,-0.773010453362726,-0.949528180593030,-0.998795456205174,-0.914209755703543,-0.707106781186571,-0.405241314004998,-0.0490676743274310,0.313681740398875,0.634393284163629,0.870086991108699,0.989176509964777,0.975702130038536,0.831469612302566,0.575808191417855,0.242980179903279,-0.122410675199196,-0.471396736825977,-0.757208846506466,-0.941544065183010,-0.999698818696205,-0.923879532511291,-0.724247082951477,-0.427555093430299,-0.0735645635996903,0.290284677254437,0.615231590580603,0.857728610000254,0.985277642388939,0.980785280403233,0.844853565249717,0.595699304492451,0.266712757474923,-0.0980171403295309,-0.449611329654576,-0.740951125354934,-0.932992798834734,-1,-0.932992798834747,-0.740951125354976,-0.449611329654632,-0.0980171403295933,0.266712757474863,0.595699304492424,0.844853565249699,0.980785280403227,0.985277642388945,0.857728610000286,0.615231590580652,0.290284677254497,-0.0735645635996561,-0.427555093430268,-0.724247082951454,-0.923879532511278,-0.999698818696204,-0.941544065183031,-0.757208846506507,-0.471396736826032,-0.122410675199230,0.242980179903246,0.575808191417827,0.831469612302531,0.975702130038522,0.989176509964786,0.870086991108730,0.634393284163656,0.313681740398908,-0.0490676743273967,-0.405241314004967,-0.707106781186527,-0.914209755703517,-0.998795456205171,-0.949528180593041,-0.773010453362747,-0.492898192229802,-0.146730474455386,0.219101240156842,0.555570233019576,0.817584813151563,0.970031253194534,0.992479534598712,0.881921264348364,0.653172842953795,0.336889853392246,-0.0245412285228811,-0.382683432365057,-0.689540544737039,-0.903989293123437,-0.997290456678689,-0.956940335732215,-0.788346427626622,-0.514102744193248,-0.170961888760335,0.195090322016091,0.534997619887086,0.803207531480634,0.963776065795434,0.995184726672199,0.893224301195529,0.671558954847043,0.359895036535023,1.27375646724057e-14,-0.359895036534973,-0.671558954847003,-0.893224301195504,-0.995184726672194,-0.963776065795449,-0.803207531480667,-0.534997619887131,-0.195090322016144,0.170961888760282,0.514102744193202,0.788346427626589,0.956940335732200,0.997290456678693,0.903989293123460,0.689540544737078,0.382683432365107,0.0245412285229350,-0.336889853392195,-0.653172842953754,-0.881921264348339,-0.992479534598705,-0.970031253194547,-0.817584813151594,-0.555570233019620,-0.219101240156895,0.146730474455332,0.492898192229755,0.773010453362713,0.949528180593024,0.998795456205173,0.914209755703539,0.707106781186565,0.405241314005016,0.0490676743274506,-0.313681740398857,-0.634393284163614,-0.870086991108704,-0.989176509964778,-0.975702130038534,-0.831469612302561,-0.575808191417871,-0.242980179903298,0.122410675199177,0.471396736825984,0.757208846506472,0.941544065183013,0.999698818696205,0.923879532511299,0.724247082951491,0.427555093430317,0.0735645635997098,-0.290284677254445,-0.615231590580610,-0.857728610000259,-0.985277642388936,-0.980785280403232,-0.844853565249727,-0.595699304492444,-0.266712757474942,0.0980171403295397,0.449611329654559,0.740951125354940,0.932992798834737,1,0.932992798834743,0.740951125354989,0.449611329654625,0.0980171403296128,-0.266712757474871,-0.595699304492431,-0.844853565249688,-0.980785280403228,-0.985277642388949,-0.857728610000282,-0.615231590580668,-0.290284677254488,0.0735645635996649,0.427555093430251,0.724247082951460,0.923879532511270,0.999698818696204,0.941544065183038,0.757208846506502,0.471396736826049,0.122410675199250,-0.242980179903255,-0.575808191417811,-0.831469612302536,-0.975702130038518,-0.989176509964785,-0.870086991108740,-0.634393284163671,-0.313681740398900,0.0490676743273772,0.405241314004975,0.707106781186513,0.914209755703521,0.998795456205170,0.949528180593047,0.773010453362742,0.492898192229819,0.146730474455377,-0.219101240156823,-0.555570233019583,-0.817584813151552,-0.970031253194536,-0.992479534598711,-0.881921264348374,-0.653172842953788,-0.336889853392264,0.0245412285228899,0.382683432365039,0.689540544737045,0.903989293123441,0.997290456678687,0.956940335732213,0.788346427626635,0.514102744193240,0.170961888760354,-0.195090322016100,-0.534997619887093,-0.803207531480623,-0.963776065795437,-0.995184726672201,-0.893224301195525,-0.671558954847058,-0.359895036535015,-6.07598126955332e-14,0.359895036534954,0.671558954847010,0.893224301195496,0.995184726672195,0.963776065795454,0.803207531480661,0.534997619887148,0.195090322016163,-0.170961888760291,-0.514102744193185,-0.788346427626595,-0.956940335732194,-0.997290456678692,-0.903989293123469,-0.689540544737092,-0.382683432365099,-0.0245412285229545,0.336889853392203,0.653172842953739,0.881921264348343,0.992479534598703,0.970031253194552,0.817584813151589,0.555570233019637,0.219101240156886,-0.146730474455313,-0.492898192229763,-0.773010453362701,-0.949528180593027,-0.998795456205173,-0.914209755703547,-0.707106781186559,-0.405241314005034,-0.0490676743274418,0.313681740398838,0.634393284163621,0.870086991108708,0.989176509964775,0.975702130038532,0.831469612302572,0.575808191417864,0.242980179903317,-0.122410675199186,-0.471396736825992,-0.757208846506459,-0.941544065183016,-0.999698818696205,-0.923879532511295,-0.724247082951504,-0.427555093430309,-0.0735645635997294,0.290284677254426,0.615231590580617,0.857728610000249,0.985277642388938,0.980785280403241,0.844853565249723,0.595699304492483,0.266712757474934,-0.0980171403295485,-0.449611329654567,-0.740951125354946,-0.932992798834720,-1,-0.932992798834761,-0.740951125354983,-0.449611329654617,-0.0980171403296040,0.266712757474880,0.595699304492392,0.844853565249693,0.980785280403219,0.985277642388947,0.857728610000277,0.615231590580661,0.290284677254480,-0.0735645635996170,-0.427555093430259,-0.724247082951427,-0.923879532511274,-0.999698818696204,-0.941544065183035,-0.757208846506496,-0.471396736826041,-0.122410675199241,0.242980179903208,0.575808191417818,0.831469612302541,0.975702130038520,0.989176509964783,0.870086991108735,0.634393284163664,0.313681740398945,-0.0490676743273860,-0.405241314004931,-0.707106781186519,-0.914209755703524,-0.998795456205170,-0.949528180593044,-0.773010453362772,-0.492898192229811,-0.146730474455425,0.219101240156832,0.555570233019590,0.817584813151557,0.970031253194539,0.992479534598717,0.881921264348369,0.653172842953824,0.336889853392256,-0.0245412285228987,-0.382683432365047,-0.689540544737051,-0.903989293123420,-0.997290456678688,-0.956940335732227,-0.788346427626629,-0.514102744193233,-0.170961888760346,0.195090322016108,0.534997619887053,0.803207531480628,0.963776065795424,0.995184726672201,0.893224301195521,0.671558954847051,0.359895036535006,5.19386418578527e-14,-0.359895036534963,-0.671558954846974,-0.893224301195499,-0.995184726672196,-0.963776065795451,-0.803207531480656,-0.534997619887140,-0.195090322016154,0.170961888760243,0.514102744193192,0.788346427626600,0.956940335732197,0.997290456678692,0.903989293123465,0.689540544737086,0.382683432365143,0.0245412285229457,-0.336889853392158,-0.653172842953745,-0.881921264348347,-0.992479534598704,-0.970031253194550,-0.817584813151617,-0.555570233019629,-0.219101240156933,0.146730474455322,0.492898192229770,0.773010453362706,0.949528180593029,0.998795456205175,0.914209755703544,0.707106781186593,0.405241314005026,0.0490676743274330,-0.313681740398847,-0.634393284163628,-0.870086991108684,-0.989176509964777,-0.975702130038542,-0.831469612302567,-0.575808191417857,-0.242980179903309,0.122410675199194,0.471396736825950,0.757208846506465,0.941544065183000,0.999698818696205,0.923879532511292,0.724247082951498,0.427555093430301,0.0735645635997206,-0.290284677254435,-0.615231590580579,-0.857728610000253,-0.985277642388939,-0.980785280403239,-0.844853565249718,-0.595699304492475,-0.266712757474925,0.0980171403295007,0.449611329654575,0.740951125354913,0.932992798834723,1,0.932992798834757,0.740951125354977,0.449611329654660,0.0980171403295953,-0.266712757474834,-0.595699304492399,-0.844853565249697,-0.980785280403221,-0.985277642388946,-0.857728610000302,-0.615231590580654,-0.290284677254526,0.0735645635996258,0.427555093430267,0.724247082951433,0.923879532511277,0.999698818696203,0.941544065183032,0.757208846506527,0.471396736826034,0.122410675199232,-0.242980179903217,-0.575808191417826,-0.831469612302514,-0.975702130038522,-0.989176509964791,-0.870086991108731,-0.634393284163657,-0.313681740398937,0.0490676743273948,0.405241314004939,0.707106781186526,0.914209755703505,0.998795456205171,0.949528180593041,0.773010453362767,0.492898192229803,0.146730474455416,-0.219101240156840,-0.555570233019550,-0.817584813151562,-0.970031253194527,-0.992479534598716,-0.881921264348365,-0.653172842953818,-0.336889853392248,0.0245412285228507,0.382683432365056,0.689540544737017,0.903989293123424,0.997290456678689,0.956940335732224,0.788346427626624,0.514102744193274,0.170961888760337,-0.195090322016061,-0.534997619887060,-0.803207531480633,-0.963776065795426,-0.995184726672200,-0.893224301195542,-0.671558954847045,-0.359895036535051};
// Window coefficients
__attribute__((aligned(16)))
float wind[N_SAMPLES];
// working complex array
__attribute__((aligned(16)))
float y_cf[N_SAMPLES * 2];
// Pointers to result arrays
float *y_cf_real = &y_cf[0];
float *y_cf_imag = &y_cf[N_SAMPLES];

// Frequency bins and magnitudes
float frequencies[N_SAMPLES ];
float magnitudes[N_SAMPLES ];

void app_main()
{
    esp_err_t ret;
    ESP_LOGI(TAG, "Start Example.");
    ret = dsps_fft2r_init_fc32(NULL, CONFIG_DSP_MAX_FFT_SIZE);
    if (ret  != ESP_OK) {
        ESP_LOGE(TAG, "Not possible to initialize FFT. Error = %i", ret);
        return;
    }

    // Generate hann window
    dsps_wind_hann_f32(wind, N);
    // Generate input signal
    //dsps_tone_gen_f32(x, N, 1.0, 0.16,  0); // A=1, F=0.16

    // Apply windowing
    for (int i = 0; i < N; i++) {
        y_cf_real[i] = x[i] * wind[i];
        y_cf_imag[i] = 0.0; // Imaginary part is zero for real input
    }

    // FFT
    unsigned int start_b = dsp_get_cpu_cycle_count();
    dsps_fft2r_fc32(y_cf, N);
    unsigned int end_b = dsp_get_cpu_cycle_count();
    // Bit reverse
    dsps_bit_rev_fc32(y_cf, N);
    // Convert complex vector to real and imaginary parts
    dsps_cplx2reC_fc32(y_cf, N);

    // Calculate frequency and magnitude for each frequency bin
    for (int i = 0; i < N ; i++) {
        frequencies[i] = (float)i / N;
        magnitudes[i] = sqrt(y_cf_real[i] * y_cf_real[i] + y_cf_imag[i] * y_cf_imag[i]);
    }

    // Print frequency and magnitude
    for (int i = 0; i < N ; i++) {
        printf("%.2f\n",magnitudes[i]);
    }

    ESP_LOGI(TAG, "FFT for %i complex points take %i cycles", N, end_b - start_b);

    ESP_LOGI(TAG, "End Example.");
}
